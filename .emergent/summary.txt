<analysis>**original_problem_statement**: The initial request was to build a customer management application by cloning a git repository, integrating a Demo Mode, and connecting to an external MyGenie API for user authentication and customer data synchronization.

The scope has since expanded to include:
1.  **Bi-directional Sync**: Sync customer data from MyGenie to the local DB (as a manual action) and receive data from external POS systems.
2.  **Schema Expansion**: Add detailed loyalty, wallet, and profile fields to the local customer database.
3.  **POS Integration Webhooks**: Create secure, API-key-authenticated endpoints for external Point-of-Sale (POS) systems to push customer and order data into this application's database.
4.  **Manual Sync Control**: Remove the automatic sync on login and provide a UI button for manual sync, which is only visible when no customers exist for the logged-in user.
5.  **Order Processing**: Implement a webhook to receive order data from MyGenie, automatically create customers, calculate and award loyalty points, and update customer statistics.

**User's preferred language**: English

**what currently exists?**
A full-stack application (React frontend, FastAPI backend, MongoDB) is running. It features a dual-login system (Demo Mode and Live Mode via MyGenie API).

Key functionalities:
-   **Manual Customer Sync**: A Sync MyGenie button on the Customers page allows users in Live Mode to pull all their customer data from the MyGenie API. This button is only visible if they currently have zero customers in the local database. The automatic sync on login has been removed.
-   **POS Integration Webhooks**: A suite of endpoints under  allows external systems to interact with the application using an  for authentication:
    -   : Create a customer.
    -   : Update a customer.
    -   : Look up a customer by phone number.
    -   : A newly created webhook to receive and process order data. It handles new customer creation, loyalty point calculation based on a local tier system, and updates customer visit/spending stats. It also has protection against processing duplicate orders.

**Last working item**:
-   **Last item agent was working**: Implementing the new order processing webhook (). The agent worked with the user to define the payload structure, implemented the backend logic, tested it successfully with , and updated the API documentation.
-   **Status**: USER VERIFICATION PENDING
-   **Agent Testing Done**: Y
-   **Which testing method agent to use?**: backend testing agent. A persistent test should be created for the new  webhook to ensure its logic (new customer creation, point calculation, duplicate order rejection) is robust.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
*   There are no outstanding bugs. The primary pending item is user verification of the newly created order webhook.

**Issues Detail**:
*   N/A

**In progress Task List**:
*   **Task 1: Verify Order Webhook Implementation (P0)**
    *   **Where to resume**: The user needs to review the functionality of the  endpoint and the updated API documentation. The user also needs to provide the final API field names for , , , and , which were unknown during implementation.
    *   **What will be achieved with this?**: Finalizes the order processing feature, a core part of the application logic.
    *   **Status**: USER VERIFICATION PENDING
    *   **Should Test frontend/backend/both after fix?**: Backend
    *   **Blocked on something**: User feedback and missing field names.

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **Task 1 (P1)**: Refactor hardcoded MyGenie API URLs from  files (, ) into the backend  file.
*   **Future Tasks**:
    *   **Task 2 (P2)**: Implement UI and functionality for customers to redeem loyalty points and use their wallet balance.
    *   **Task 3 (P3)**: Address incomplete loyalty/wallet data from the MyGenie API sync. This is a potential blocker for the redemption UI.
    *   **Task 4 (P4)**: Consider creating a bulk sync endpoint () for MyGenie to push multiple customers at once, if the user confirms this is needed.

**Completed work in this session**
-   **Removed Auto-Sync**: Removed the automatic customer sync from the MyGenie login process in .
-   **Conditional Sync Button**: Updated  to only show the Sync MyGenie button if the user is in Live Mode and has no customers.
-   **Created Order Webhook**:
    -   Implemented a new endpoint  in .
    -   This webhook auto-creates customers, calculates and awards loyalty points based on a tier system, updates customer stats, and prevents duplicate orders.
    -   Created a new  schema and  collection.
-   **API Documentation**: Created and updated  with details for all POS endpoints.
-   **Database Cleanup**: Cleared the database of non-test users and customers as requested by the user.

**Earlier issues found/mentioned but not fixed**
*   **Issue 1: Incomplete Loyalty/Wallet Data from MyGenie API**
    *   The MyGenie customer list API used for the manual sync only provides current balances (, ) and not the detailed transaction history (, , etc.) required for a full-featured loyalty UI. The new order webhook now tracks this locally, but historical data is missing.
    *   **Debug checklist**:
        1.  Re-confirm with the user if an alternate MyGenie API endpoint provides this detailed transaction data.
        2.  Discuss whether historical transaction data should be tracked locally going forward, now that the order webhook is in place.
    *   **Why to solve this issue and what will be achieved with this?**: This is a blocker for the future task of displaying detailed loyalty and wallet history in the UI.
    *   **Should Test frontend/backend/both after fix**: Backend (API investigation).
    *   **Is recurring issue?**: N

**Known issue recurrence from previous fork**
*   None.

**Code Architecture**


**Key Technical Concepts**
*   **Frontend**: React, Axios, React Context API.
*   **Backend**: FastAPI, Motor (async MongoDB driver), Pydantic.
*   **Database**: MongoDB.
*   **Authentication**: JWT-based for the application's internal sessions; API Key-based ( header) for the external POS webhook endpoints.

**key DB schema**
*   **customers**: 
*   **orders**: 

**changes in tech stack**
*   None.

**All files of reference**
*   : Modified to remove auto-sync on login.
*   : Modified to add the  webhook and its business logic.
*   : Created for the new order Pydantic model.
*   : Modified for the conditional Sync MyGenie button logic.
*   : Created and updated to document the POS APIs for external developers.

**Areas that need refactoring**:
*   Hardcoded MyGenie API URLs in  and  should be moved to the  file.

**key api endpoints**
*   : Authenticates user via MyGenie. (Auto-sync removed).
*   : Manually triggers a customer data pull **from** MyGenie.
*   : **(Webhook)** Creates a customer.
*   : **(Webhook)** Updates a customer.
*   : **(Webhook)** Looks up a customer by phone.
*   : **(Webhook - NEW)** Receives and processes order data from a POS.

**Critical Info for New Agent**
*   **Active Directory**: The correct and active codebase is in , not . The previous agent initially worked in the wrong directory before realizing this and cleaning up.
*   **User Interaction**: The user provides requirements incrementally. Always confirm your understanding and proposed plan before implementation.
*   **Pending User Input**: The user still needs to provide the final field names for , , , and  for the new order webhook payload. The current implementation uses placeholders.
*   **API Key**: The active API key for testing POS webhooks is stored in the user object in the database and is retrieved during the webhook's authentication check. Do not rely on hardcoded keys.

**documents and test reports created in this job**
*   

**Last 10 User Messages and any pending HUMAN messages**
1.  **msg 198**: User asks to include  in the order webhook payload. (Status: Completed)
2.  **msg 200**: User clarifies that  is only needed for new customers. (Status: Completed)
3.  **msg 202**: User states they will get the  field name later. (Status: In Progress - Pending User)
4.  **msg 204**: User clarifies which loyalty/wallet fields MyGenie sends. (Status: Completed)
5.  **msg 206**: User states they will get the remaining field names later and asks for the final expected payload. (Status: In Progress - Pending User)
6.  **msg 208**: User requests to remove several fields from the proposed payload. (Status: Completed)
7.  **msg 210**: User gives the go-ahead to create the webhook with the agreed structure. (Status: Completed)
8.  **msg 212-228**: Agent implements and tests the new  webhook. (Status: Completed)
9.  **msg 231**: Agent provides a summary of the completed order webhook and the updated API documentation. (Status: Completed)
10. **(No pending messages)**

**Project Health Check:**
*   **Broken**: None.
*   **Mocked**: The MyGenie API is a live external integration.

**3rd Party Integrations**
*   **MyGenie API**: Used for user authentication and customer data synchronization.

**Testing status**
*   **Testing agent used after significant changes**: NO
*   **Troubleshoot agent used after agent stuck in loop**: NO
*   **Test files created**: None
*   **Known regressions**: None

**Credentials to test flow:**
*   **MyGenie User (for login)**:
    *   Email: 
    *   Password: 
*   **POS Webhook API Key**:
    *   The API key is dynamically retrieved from the user's record in the database during the request. To test, you must first log in as a user (e.g., the MyGenie user above) to ensure a user record with an API key exists. The key  was mentioned initially, but the agent discovered the correct way is to use the one associated with the user account.

**What agent forgot to execute**
*   The task to refactor hardcoded URLs into the  file is still pending from a previous session.
*   The unresolved issue regarding incomplete loyalty/wallet data from the MyGenie API was not re-addressed with the user. This will be important before starting UI work on loyalty features.</analysis>
