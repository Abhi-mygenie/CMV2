<analysis>**original_problem_statement**: The initial request was to build a customer management application by cloning a git repository, integrating a Demo Mode, and connecting to an external MyGenie API for user authentication and customer data synchronization.

The scope has since expanded to include:
1.  **Bi-directional Sync**:
    *   Sync customer data **FROM** MyGenie to the local DB (originally on login, now to be a manual-only action).
    *   Sync customer data **TO** MyGenie when a customer is created or updated within this application.
2.  **Schema Expansion**: Add detailed loyalty, wallet, and profile fields to the local customer database.
3.  **POS Integration Webhooks**: Create a set of secure, API-key-authenticated endpoints for external Point-of-Sale (POS) systems like MyGenie to push customer data (creations/updates) into this application's database.
4.  **New Sync API**: Create a new endpoint that allows a logged-in user to manually trigger a full customer sync from MyGenie, and remove the automatic sync that currently happens on login.

**User's preferred language**: English

**what currently exists?**
A full-stack application (React frontend, FastAPI backend, MongoDB) is running. It features a dual-login system (Demo Mode and Live Mode via MyGenie API).

The application supports bi-directional data flow with the MyGenie API:
-   **Push to MyGenie**: When a customer is created or edited in the app's UI, the changes are pushed to the MyGenie API.
-   **Pull from MyGenie**: A function exists to pull all customer data from MyGenie, which is currently triggered automatically on user login.

Webhook endpoints ( and ) have been created to allow external POS systems to create and update customers in the local database. These are secured with an  header and support a comprehensive payload including  and .

**Last working item**:
*   **Last item agent was working**: The agent was confirming the requirements for the user's latest request: to create a new manual sync API and remove the existing auto-sync-on-login feature. The user wants a Sync button in the UI that will trigger a full customer data pull from the MyGenie API.
*   **Status**: NOT STARTED
*   **Agent Testing Done**: N/A
*   **Which testing method agent to use?**: backend testing agent. After implementation, the agent should:
    1.  Confirm the auto-sync on login is removed.
    2.  Test the new manual sync endpoint to verify it correctly pulls and updates customer data from the MyGenie API.
*   **User Testing Done**: N

**All Pending/In progress Issue list**:
*   There are no outstanding bugs. The focus is on implementing the new feature requested by the user.

**Issues Detail**:
*   N/A

**In progress Task List**:
*   **Task 1: Implement New Manual Sync Mechanism (P0)**
    *   **Where to resume**:
        1.  In , remove the call to  from the login endpoint.
        2.  Create a new endpoint, such as , in .
        3.  This new endpoint should be protected by the standard user JWT authentication and should call the existing  function to perform the sync.
    *   **What will be achieved with this?**: The customer sync will no longer happen automatically on every login, reducing redundant API calls. Instead, it will be a deliberate action initiated by the user from the frontend.
    *   **Status**: NOT STARTED
    *   **Should Test frontend/backend/both after fix?**: Backend
    *   **Blocked on something**: None

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **Task 1 (P1)**: Add a Sync button in the frontend (e.g., in a Settings page) to call the newly created manual sync API.
    *   **Task 2 (P2)**: Refactor hardcoded MyGenie API URLs from  files into the backend  file for better configuration management.
*   **Future Tasks**:
    *   **Task 3 (P3)**: Implement UI and functionality for customers to redeem loyalty points and use their wallet balance.

**Completed work in this session**
-   **Sync to MyGenie**: Implemented functionality to sync customer creations and updates from the local application *to* the MyGenie API.
-   **POS Integration Webhooks**:
    -   Created  endpoint for external systems to create customers.
    -   Created  endpoint for external systems to update customers.
    -   Secured these endpoints using an  header.
-   **Payload Finalization**: Iteratively refined the webhook payload with the user to include a comprehensive set of customer fields, including  and .

**Earlier issues found/mentioned but not fixed**
*   **Issue 1: Incomplete Loyalty/Wallet Data from MyGenie API**
    *   During the initial sync implementation, the agent discovered that the MyGenie customer list API only returns current balances (, ) and not the detailed transaction history fields (, , etc.) that the user requested.
    *   **Debug checklist**:
        1.  Re-confirm with the user if there is an alternate MyGenie API endpoint that provides this detailed data.
        2.  Discuss whether this data should be tracked locally within this application instead of relying on the MyGenie sync.
    *   **Why to solve this issue and what will be achieved with this?**: This is a blocker for the original requirement of displaying detailed loyalty and wallet history in the UI.
    *   **Should Test frontend/backend/both after fix**: Backend (API investigation).
    *   **Is recurring issue?**: N

**Known issue recurrence from previous fork**
*   None.

**Code Architecture**


**Key Technical Concepts**
*   **Frontend**: React, Axios, React Context API.
*   **Backend**: FastAPI, Motor (async MongoDB driver), Pydantic.
*   **Database**: MongoDB.
*   **Authentication**:
    *   JWT-based for the application's internal session management.
    *   API Key-based ( header) for the external POS webhook endpoints.

**key DB schema**
*   **customers**: 

**changes in tech stack**
*   None.

**All files of reference**
*   : To be modified to remove auto-sync.
*   : Contains existing customer logic; will be modified to add the new manual sync endpoint.
*   : Contains the newly created webhook endpoints for POS systems.
*   : Contains the updated Pydantic models for customer data.

**Areas that need refactoring**:
*   Hardcoded MyGenie API URLs in  and  should be moved to the  file.

**key api endpoints**
*   : Authenticates user. (Auto-sync to be removed).
*   : Creates a customer and syncs it **to** MyGenie.
*   : Updates a customer and syncs it **to** MyGenie.
*   : **(Webhook)** Creates a customer from an external POS.
*   : **(Webhook)** Updates a customer from an external POS.
*   : **(To be created)** Manually triggers a sync **from** MyGenie.

**Critical Info for New Agent**
*   The application now handles three types of data synchronization: pushing local changes to MyGenie, pulling remote changes from MyGenie (manually), and receiving data from external POS systems via webhooks. Be mindful of which flow you are working on.
*   The webhook APIs () use a different authentication method (API Key) than the internal app APIs (, JWT).
*   The user is very hands-on and requires confirmation of your understanding before you begin implementation. Use the  tool frequently to propose plans and clarify requirements.

**documents and test reports created in this job**
*   None in this session.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (msg 134):** Clarified that  is for the POS system (e.g., mygenie) and  is for the restaurant. (Status: Completed)
2.  **User (msg 136):** Confirmed understanding and asked for the final payload before implementation. (Status: Completed)
3.  **User (msg 138):** Approved the final payload and instructed the agent to proceed. (Status: Completed)
4.  **User (msg 158):** Stated that the phone number must be a required field for the update endpoint as it's the unique key. (Status: Completed)
5.  **User (msg 168):** Asked for the  commands for the completed create and update endpoints. (Status: Completed)
6.  **User (msg 170):** Requested a new  API that will be triggered by a UI button. Specified that the automatic sync on login should be removed and asked the agent to state their understanding before proceeding. (Status: In Progress - this is the current active task).

**Project Health Check:**
*   **Broken**: None.
*   **Mocked**: The MyGenie API is a live external integration.

**3rd Party Integrations**
*   **MyGenie API**: Used for user authentication and bi-directional customer data synchronization.

**Testing status**
*   **Testing agent used after significant changes**: NO
*   **Troubleshoot agent used after agent stuck in loop**: NO
*   **Test files created**: None
*   **Known regressions**: None

**Credentials to test flow:**
*   **MyGenie User (for login)**:
    *   Email: 
    *   Password: 
*   **POS Webhook API Key**:
    *   Header: 
    *   Value: 

**What agent forgot to execute**
*   The agent has correctly queued up the user's latest request but has not yet started the implementation.
*   The unresolved issue regarding incomplete loyalty/wallet data from the MyGenie API was put on hold and needs to be brought back to the user's attention before related UI work can begin.
*   The task to refactor hardcoded URLs into the  file is still pending from the previous session.</analysis>
