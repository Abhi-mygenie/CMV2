<analysis>**original_problem_statement**: The initial request was to build a customer management application by cloning a git repository, integrating a Demo Mode, and connecting to an external MyGenie API for user authentication and customer data synchronization.

The scope has since expanded to include:
1.  **Bi-directional Sync**: Sync customer data from MyGenie to the local DB (as a manual action) and receive data from external POS systems via webhooks.
2.  **Schema Expansion**: Add detailed loyalty, wallet, and profile fields to the local customer database.
3.  **POS Integration Webhooks**: Create secure, API-key-authenticated endpoints for external Point-of-Sale (POS) systems to push customer, order, and loyalty data.
4.  **Loyalty & Wallet Logic**: Implement backend logic to calculate loyalty points based on configurable tiers, deduct used wallet balances from customer profiles, and provide endpoints for POS systems to validate redeemable points before a transaction.

**User's preferred language**: English

**what currently exists?**
A full-stack application (React frontend, FastAPI backend, MongoDB) with a dual-login system (Demo Mode and Live Mode via MyGenie API).

Key functionalities:
-   **Manual Customer Sync**: A Sync MyGenie button on the Customers page allows users to pull data from the MyGenie API.
-   **Configurable Loyalty System**: A settings page in the UI allows the user to define loyalty tiers, points-to-currency conversion rates, and minimum order values.
-   **POS Integration Webhooks**: A suite of endpoints under  for external systems, authenticated via an  header:
    -   : Create a customer.
    -   : Update a customer.
    -   : Look up a customer by phone number.
    -   : Processes an order, correctly calculates and awards loyalty points based on tier settings, and deducts any used wallet balance from the customer's profile.
    -   : A new endpoint that calculates the maximum loyalty points a customer can redeem for a given bill amount, based on their current balance and the app's loyalty settings.
-   **API Documentation**: An  file detailing the POS endpoints.

**Last working item**:
-   **Last item agent was working**: Created a new API endpoint  to allow POS systems to check the maximum loyalty points a customer can use for a given bill amount. The agent implemented the logic, tested it successfully with , and updated the  file as requested by the user.
-   **Status**: USER VERIFICATION PENDING
-   **Agent Testing Done**: Y
-   **Which testing method agent to use?**: backend testing agent. A persistent test should be created for the new  webhook.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
*   There are no outstanding bugs reported by the user. The main pending items are user verification of the last session's work.

**Issues Detail**:
*   N/A

**In progress Task List**:
*   **Task 1: Verify New  Endpoint (P0)**
    *   **Where to resume**: The user needs to review the functionality and documentation for the newly created  endpoint.
    *   **What will be achieved with this?**: Finalizes a key piece of the loyalty redemption flow for external POS systems.
    *   **Status**: USER VERIFICATION PENDING
    *   **Should Test frontend/backend/both after fix?**: Backend
    *   **Blocked on something**: User feedback.
*   **Task 2: Verify Wallet Deduction Fix (P1)**
    *   **Where to resume**: The user needs to verify that the  webhook now correctly deducts the  amount from a customer's .
    *   **What will be achieved with this?**: Confirms a critical bug fix in the order processing logic is working as expected.
    *   **Status**: USER VERIFICATION PENDING
    *   **Should Test frontend/backend/both after fix?**: Backend
    *   **Blocked on something**: User feedback.

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **Task 1 (P1)**: Refactor hardcoded MyGenie API URLs from  files (, ) into the backend  file.
*   **Future Tasks**:
    *   **Task 2 (P2)**: Implement UI and functionality for customers to redeem loyalty points and use their wallet balance within the application itself.
    *   **Task 3 (P3)**: Address incomplete loyalty/wallet data from the MyGenie API sync. This is a potential blocker for the redemption UI.
    *   **Task 4 (P4)**: Consider creating a bulk sync endpoint () for MyGenie to push multiple customers at once, if the user confirms this is needed.

**Completed work in this session**
-   **Fixed Wallet Deduction Bug**: Identified and fixed a critical bug in the  webhook where the  amount was not being subtracted from the customer's . The fix was added to .
-   **Verified Loyalty Logic**: Confirmed through a series of tests that the order webhook correctly calculates loyalty points based on tier settings stored in the database, including handling tier upgrades.
-   **Created Max Redeemable Points Endpoint**: Implemented and tested a new endpoint, , in  to calculate the maximum redeemable points for a transaction.
-   **Updated API Documentation**: Updated  to include the new  endpoint and to add  to the response of the order webhook.

**Earlier issues found/mentioned but not fixed**
*   **Issue 1: Incomplete Loyalty/Wallet Data from MyGenie API**
    *   The MyGenie customer API used for manual sync only provides current balances, not the detailed transaction history required for a full-featured loyalty UI. The new order webhook tracks this locally for new orders, but historical data is missing for synced customers.
    *   **Debug checklist**:
        1.  Confirm with the user if an alternate MyGenie API endpoint exists that provides this data.
        2.  Discuss whether to only track this data locally going forward.
    *   **Why to solve this issue and what will be achieved with this?**: This is a blocker for the future task of displaying detailed loyalty and wallet history in the UI.
    *   **Should Test frontend/backend/both after fix**: Backend (API investigation).
    *   **Is recurring issue?**: N

**Known issue recurrence from previous fork**
*   None.

**Code Architecture**


**Key Technical Concepts**
*   **Frontend**: React, Axios.
*   **Backend**: FastAPI, Motor (async MongoDB driver), Pydantic.
*   **Database**: MongoDB.
*   **Authentication**: JWT-based for internal sessions; API Key-based ( header) for external POS webhooks.

**key DB schema**
*   **customers**: 
*   **orders**: 
*   **settings**: 

**changes in tech stack**
*   None.

**All files of reference**
*   : Heavily modified to fix the wallet deduction bug and add the  endpoint.
*   : Updated to document the new endpoint and reflect changes to the order webhook response.
*   : Viewed to understand how loyalty settings are structured.
*   : Viewed to understand the loyalty calculation logic.

**Areas that need refactoring**:
*   Hardcoded MyGenie API URLs in  and  should be moved to the  file.

**key api endpoints**
*   : Authenticates user via MyGenie.
*   : Manually triggers a customer data pull from MyGenie.
*   : **(Webhook)** Creates a customer.
*   : **(Webhook)** Updates a customer.
*   : **(Webhook)** Looks up a customer by phone.
*   : **(Webhook)** Receives and processes order data.
*   : **(Webhook - NEW)** Returns max redeemable points for a bill.

**Critical Info for New Agent**
*   The user directs development incrementally. The immediate next step is to get the user's verification on the wallet deduction fix and the new  endpoint.
*   The API documentation in  is important to the user and should be kept up-to-date with any changes to the POS webhooks.

**documents and test reports created in this job**
*    (Updated)

**Last 10 User Messages and any pending HUMAN messages**
1.  **msg 74**: User requested an API to return available loyalty points for a customer to use in a transaction. (Status: Completed)
2.  **msg 77**: User specified the inputs (, , , ) and output () for the new API. (Status: Completed)
3.  **msg 80**: User clarified that the new API should focus only on loyalty points, not wallet balance. (Status: Completed)
4.  **msg 83**: User confirmed YEs to the agent's proposed plan to implement the new endpoint. (Status: Completed)
5.  **msg 98**: User requested the final webhook structure and documentation for the new endpoint. (Status: Completed)
6.  **msg 101**: User confirmed yes, greenlighting the agent to provide the documentation. (Status: Completed)
7.  **(No pending messages)** The agent has fulfilled the last user request; the next action is to await user feedback/verification.

**Project Health Check:**
*   **Broken**: None.
*   **Mocked**: The MyGenie API is a live external integration.

**3rd Party Integrations**
*   **MyGenie API**: Used for user authentication and customer data synchronization.

**Testing status**
*   **Testing agent used after significant changes**: NO
*   **Troubleshoot agent used after agent stuck in loop**: NO
*   **Test files created**: None
*   **Known regressions**: None

**Credentials to test flow:**
*   **MyGenie User (for login)**:
    *   Email: 
    *   Password: 
*   **POS Webhook API Key**:
    *   The API key is retrieved dynamically from the user's record in the database during the request. To test, first log in as the user above to ensure a user record with an API key exists. A previously used key for testing is .

**What agent forgot to execute**
*   The pending task to refactor hardcoded URLs into the  file is still outstanding from a previous session.
*   Persistent tests (e.g., pytest) were not created for the new wallet deduction logic or the  endpoint. This should be considered to prevent future regressions.</analysis>
